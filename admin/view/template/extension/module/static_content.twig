{{ header }}{{ column_left }}
<div id="content">
  <div class="page-header">
    <div class="container-fluid">
      <div class="pull-right">
        <button type="submit" form="form-static-content" data-toggle="tooltip" title="{{ button_save }}" class="btn btn-primary btn-lg"><i class="fa fa-save"></i> {{ button_save }}</button>
        <a href="{{ seed_url }}" class="btn btn-warning" onclick="return confirm('REPLACE all content with defaults?')"><i class="fa fa-database"></i></a>
        <a href="{{ cancel }}" class="btn btn-default"><i class="fa fa-reply"></i></a>
      </div>
      <h1><i class="fa fa-edit"></i> {{ heading_title }}</h1>
      <ul class="breadcrumb">
        {% for breadcrumb in breadcrumbs %}<li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>{% endfor %}
      </ul>
    </div>
  </div>

  <div class="container-fluid">
    {% if error_warning %}<div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> {{ error_warning }}<button type="button" class="close" data-dismiss="alert">&times;</button></div>{% endif %}
    {% if success %}<div class="alert alert-success alert-dismissible"><i class="fa fa-check-circle"></i> {{ success }}<button type="button" class="close" data-dismiss="alert">&times;</button></div>{% endif %}

    <form action="{{ action }}" method="post" enctype="multipart/form-data" id="form-static-content">
      <div class="row">

        {# ===== SIDEBAR ===== #}
        <div class="col-sm-3 col-md-2">
          <div class="ce-sidebar">
            <div class="ce-sidebar-label">Сторінки</div>
            <ul class="nav" id="page-nav">
              {% for pageKey, sections in registry %}
              <li{% if pageKey == active_tab %} class="active"{% endif %}>
                <a href="#page-{{ pageKey }}" data-toggle="pill">
                  {% if pageKey == 'header' %}<i class="fa fa-arrow-up"></i> <span>{{ tab_header }}</span>
                  {% elseif pageKey == 'home' %}<i class="fa fa-home"></i> <span>{{ tab_home }}</span>
                  {% elseif pageKey == 'footer' %}<i class="fa fa-arrow-down"></i> <span>{{ tab_footer }}</span>
                  {% else %}<i class="fa fa-file-o"></i> <span>{{ pageKey|capitalize }}</span>{% endif %}
                  <span class="badge pull-right">{{ sections|length }}</span>
                </a>
              </li>
              {% endfor %}
            </ul>
            <div class="ce-sidebar-label" style="margin-top:12px;">Інше</div>
            <ul class="nav">
              <li{% if active_tab == 'docs' %} class="active"{% endif %}>
                <a href="#page-docs" data-toggle="pill"><i class="fa fa-book"></i> <span>{{ tab_docs }}</span></a>
              </li>
            </ul>
          </div>
        </div>

        {# ===== MAIN ===== #}
        <div class="col-sm-9 col-md-10">
          <div class="tab-content" id="page-content">

            {# Counter for unique IDs #}
            {% set uid = [0] %}

            {% for pageKey, sections in registry %}
            <div class="tab-pane{% if pageKey == active_tab %} active{% endif %}" id="page-{{ pageKey }}">

              {% for sectionKey, sectionDef in sections %}
              <div class="ce-block">
                <div class="ce-block-header">
                  <h3>{{ sectionDef.label }}</h3>
                  <span class="ce-block-meta">{{ pageKey }}.{{ sectionKey }}</span>
                </div>
                <div class="ce-block-body">
                  {% for fieldKey, fieldDef in sectionDef.fields %}
                    {% set ft = fieldDef.translatable is defined ? fieldDef.translatable : true %}

                    <div class="ce-field">
                      <div class="ce-field-label">{{ fieldKey }}{% if not ft %} <span class="label label-default" style="font-size:10px;">global</span>{% endif %}</div>

                      {% if ft %}
                        <div class="ce-lang-grid">
                          {% for language in languages %}
                          <div class="ce-lang-col">
                            <div class="ce-lang-flag"><img src="language/{{ language.code }}/{{ language.code }}.png" /> {{ language.name }}</div>

                            {% set cv = '' %}
                            {% if content[pageKey] is defined and content[pageKey][sectionKey] is defined and content[pageKey][sectionKey][fieldKey] is defined and content[pageKey][sectionKey][fieldKey][language.language_id] is defined %}
                              {% set cv = content[pageKey][sectionKey][fieldKey][language.language_id].value %}
                            {% endif %}

                            {% if fieldDef.schema is defined and fieldDef.schema == 'repeater' %}
                              {% set rid = 'rep-' ~ pageKey ~ '-' ~ sectionKey ~ '-' ~ fieldKey ~ '-' ~ language.language_id %}
                              <div class="repeater-container" id="{{ rid }}"
                                   data-page="{{ pageKey }}" data-section="{{ sectionKey }}" data-field="{{ fieldKey }}"
                                   data-lang="{{ language.language_id }}" data-translatable="1"
                                   data-columns='{{ fieldDef.columns|json_encode }}'
                                   data-col-types='{{ fieldDef.col_types is defined ? fieldDef.col_types|json_encode : '{}' }}'
                                   data-placeholder="{{ placeholder }}"></div>
                              <script type="application/json" data-for="{{ rid }}">{{ cv ? cv|raw : '[]' }}</script>

                            {% elseif fieldDef.type == 'text' %}
                              <input type="text" name="{{ pageKey }}[{{ sectionKey }}][{{ fieldKey }}][{{ language.language_id }}]" value="{{ cv|e('html_attr') }}" class="form-control" />

                            {% elseif fieldDef.type == 'textarea' %}
                              <textarea name="{{ pageKey }}[{{ sectionKey }}][{{ fieldKey }}][{{ language.language_id }}]" rows="3" class="form-control">{{ cv|e }}</textarea>

                            {% elseif fieldDef.type == 'wysiwyg' %}
                              <textarea name="{{ pageKey }}[{{ sectionKey }}][{{ fieldKey }}][{{ language.language_id }}]" rows="6" class="form-control wysiwyg-editor">{{ cv|e }}</textarea>

                            {% elseif fieldDef.type == 'image' %}
                              {% set iid = 'img-' ~ pageKey ~ '-' ~ sectionKey ~ '-' ~ fieldKey ~ '-' ~ language.language_id %}
                              <div class="ce-img-widget">
                                <a href="" id="thumb-{{ iid }}" data-toggle="image" class="img-thumbnail">
                                  <img src="{{ cv ? image_base ~ cv : placeholder }}" alt="" data-placeholder="{{ placeholder }}" />
                                </a>
                                <input type="hidden" name="{{ pageKey }}[{{ sectionKey }}][{{ fieldKey }}][{{ language.language_id }}]" value="{{ cv }}" id="input-{{ iid }}" />
                              </div>
                            {% endif %}
                          </div>
                          {% endfor %}
                        </div>

                      {% else %}
                        {% set cv = '' %}
                        {% if content[pageKey] is defined and content[pageKey][sectionKey] is defined and content[pageKey][sectionKey][fieldKey] is defined and content[pageKey][sectionKey][fieldKey]['0'] is defined %}
                          {% set cv = content[pageKey][sectionKey][fieldKey]['0'].value %}
                        {% endif %}

                        {% if fieldDef.schema is defined and fieldDef.schema == 'repeater' %}
                          {% set rid = 'rep-' ~ pageKey ~ '-' ~ sectionKey ~ '-' ~ fieldKey ~ '-0' %}
                          <div class="repeater-container" id="{{ rid }}"
                               data-page="{{ pageKey }}" data-section="{{ sectionKey }}" data-field="{{ fieldKey }}"
                               data-lang="0" data-translatable="0"
                               data-columns='{{ fieldDef.columns|json_encode }}'
                               data-col-types='{{ fieldDef.col_types is defined ? fieldDef.col_types|json_encode : '{}' }}'
                               data-placeholder="{{ placeholder }}"></div>
                          <script type="application/json" data-for="{{ rid }}">{{ cv ? cv|raw : '[]' }}</script>

                        {% elseif fieldDef.type == 'text' %}
                          <input type="text" name="{{ pageKey }}[{{ sectionKey }}][{{ fieldKey }}]" value="{{ cv|e('html_attr') }}" class="form-control" style="max-width:600px;" />

                        {% elseif fieldDef.type == 'image' %}
                          {% set iid = 'img-' ~ pageKey ~ '-' ~ sectionKey ~ '-' ~ fieldKey ~ '-0' %}
                          <div class="ce-img-widget">
                            <a href="" id="thumb-{{ iid }}" data-toggle="image" class="img-thumbnail">
                              <img src="{{ cv ? image_base ~ cv : placeholder }}" alt="" data-placeholder="{{ placeholder }}" />
                            </a>
                            <input type="hidden" name="{{ pageKey }}[{{ sectionKey }}][{{ fieldKey }}]" value="{{ cv }}" id="input-{{ iid }}" />
                          </div>
                        {% endif %}
                      {% endif %}

                    </div>
                  {% endfor %}
                </div>
              </div>
              {% endfor %}
            </div>
            {% endfor %}

            {# ===== DOCS ===== #}
            <div class="tab-pane{% if active_tab == 'docs' %} active{% endif %}" id="page-docs">
              <div class="ce-block">
                <div class="ce-block-header"><h3>Про модуль</h3></div>
                <div class="ce-block-body">
                  <p>Модуль <strong>«Редактор контенту»</strong> керує статичним контентом сайту без правок коду.</p>
                  <div class="row" style="margin-top:15px;">
                    <div class="col-md-3"><div class="ce-stat-card"><div class="ce-stat-num">{{ registry|length }}</div><div class="ce-stat-label">Сторінок</div></div></div>
                    <div class="col-md-3"><div class="ce-stat-card"><div class="ce-stat-num">{% set total = 0 %}{% for p,s in registry %}{% set total = total + s|length %}{% endfor %}{{ total }}</div><div class="ce-stat-label">Секцій</div></div></div>
                    <div class="col-md-3"><div class="ce-stat-card"><div class="ce-stat-num">{{ languages|length }}</div><div class="ce-stat-label">Мов</div></div></div>
                    <div class="col-md-3"><div class="ce-stat-card"><div class="ce-stat-num">5</div><div class="ce-stat-label">Типів полів</div></div></div>
                  </div>
                </div>
              </div>
              <div class="ce-block">
                <div class="ce-block-header"><h3><i class="fa fa-code"></i> Інтеграція</h3></div>
                <div class="ce-block-body">
                  <pre class="ce-code"><code>$this->load->model('extension/module/static_content');
$data['static_home'] = $this->model_extension_module_static_content->getPageData('home');</code></pre>
                  <pre class="ce-code"><code>{% verbatim %}{% set faq = static_home.faq %}
&lt;h2&gt;{{ faq.title }}&lt;/h2&gt;
{% for item in faq.items %}
  &lt;div&gt;{{ item.question }}&lt;/div&gt;
{% endfor %}{% endverbatim %}</code></pre>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<style>
  .ce-sidebar { background:#fff; border:1px solid #e3e3e3; border-radius:6px; padding:12px 0; position:sticky; top:10px; }
  .ce-sidebar-label { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:#999; padding:6px 18px 4px; }
  .ce-sidebar .nav>li>a { padding:9px 18px; color:#444; border-left:3px solid transparent; transition:all .15s; font-size:13px; }
  .ce-sidebar .nav>li>a:hover { background:#f7f8fa; border-left-color:#ccc; text-decoration:none; }
  .ce-sidebar .nav>li.active>a { background:linear-gradient(90deg,#e8f0fe,#fff); border-left-color:#337ab7; color:#1a73e8; font-weight:600; }
  .ce-sidebar .nav>li>a .fa { width:18px; text-align:center; margin-right:6px; }
  .ce-sidebar .nav>li>a .badge { background:#e0e0e0; color:#666; font-size:10px; }
  .ce-sidebar .nav>li.active>a .badge { background:#c2dbff; color:#1a73e8; }

  .ce-block { background:#fff; border:1px solid #e3e3e3; border-radius:6px; margin-bottom:16px; overflow:hidden; }
  .ce-block-header { background:linear-gradient(180deg,#fafbfc,#f0f1f3); padding:12px 20px; border-bottom:1px solid #e3e3e3; display:flex; align-items:center; justify-content:space-between; }
  .ce-block-header h3 { margin:0; font-size:15px; font-weight:600; color:#333; }
  .ce-block-meta { font-size:11px; color:#aaa; font-family:monospace; }
  .ce-block-body { padding:16px 20px; }

  .ce-field { margin-bottom:18px; padding-bottom:18px; border-bottom:1px solid #f0f0f0; }
  .ce-field:last-child { margin-bottom:0; padding-bottom:0; border-bottom:none; }
  .ce-field-label { font-size:12px; font-weight:600; color:#555; text-transform:uppercase; letter-spacing:.5px; margin-bottom:8px; }

  .ce-lang-grid { display:grid; gap:12px; grid-template-columns:1fr 1fr; }
  @media(max-width:991px) { .ce-lang-grid { grid-template-columns:1fr !important; } }
  .ce-lang-col { min-width:0; }
  .ce-lang-flag { font-size:11px; font-weight:600; color:#777; margin-bottom:5px; display:flex; align-items:center; gap:4px; }
  .ce-lang-flag img { height:14px; border-radius:2px; }
  .ce-lang-col .form-control { font-size:13px; }
  .ce-lang-col textarea.form-control { resize:vertical; min-height:60px; }

  /* OC3 Image widget */
  .ce-img-widget { display:inline-block; }
  .ce-img-widget .img-thumbnail { display:inline-block; max-width:120px; max-height:120px; cursor:pointer; }
  .ce-img-widget .img-thumbnail img { max-width:100px; max-height:100px; }

  /* Repeater */
  .repeater-table { width:100%; margin-bottom:8px; font-size:12px; }
  .repeater-table th { background:#f5f6f8; padding:5px 8px; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; color:#888; }
  .repeater-table td { padding:3px 5px; vertical-align:top; }
  .repeater-table input[type=text], .repeater-table textarea { width:100%; padding:4px 6px; border:1px solid #ddd; border-radius:3px; font-size:12px; }
  .repeater-table textarea { min-height:40px; resize:vertical; }
  .repeater-table .btn-sm { padding:2px 7px; font-size:11px; }
  .repeater-add-btn { margin-top:4px; font-size:11px; }
  .repeater-table .img-thumbnail { display:inline-block; padding:2px; max-width:60px; cursor:pointer; }
  .repeater-table .img-thumbnail img { max-width:56px; max-height:40px; }

  .ce-code { background:#2d2d2d; color:#f8f8f2; padding:14px 16px; border-radius:5px; font-size:12px; line-height:1.5; overflow-x:auto; border:none; }
  .ce-stat-card { background:#f7f8fa; border:1px solid #e8e8e8; border-radius:8px; padding:18px; text-align:center; margin-bottom:12px; }
  .ce-stat-num { font-size:28px; font-weight:700; color:#337ab7; }
  .ce-stat-label { font-size:12px; color:#888; text-transform:uppercase; }
  .page-header { border-bottom:2px solid #e8e8e8; }
  .page-header h1 { font-size:22px; font-weight:600; }
  .page-header h1 .fa { color:#337ab7; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {

  var placeholder = '{{ placeholder }}';
  var imageBase = '{{ image_base }}';

  // ===== Repeater =====
  document.querySelectorAll('.repeater-container').forEach(function(container) {
    var page    = container.dataset.page;
    var section = container.dataset.section;
    var field   = container.dataset.field;
    var langId  = container.dataset.lang;
    var columns, colTypes, rows;
    var ph = container.dataset.placeholder || placeholder;

    try { columns = JSON.parse(container.dataset.columns || '[]'); } catch(e) { columns = []; }
    try { colTypes = JSON.parse(container.dataset.colTypes || '{}'); } catch(e) { colTypes = {}; }
    if (!Array.isArray(columns) || columns.length === 0) return;

    var translatable = container.dataset.translatable === '1';

    rows = [];
    var jsonScript = document.querySelector('script[data-for="' + container.id + '"]');
    if (jsonScript) {
      try { rows = JSON.parse(jsonScript.textContent || '[]'); } catch(e) { rows = []; }
    }
    if (!Array.isArray(rows)) rows = [];

    function render() {
      var namePrefix = translatable
        ? page + '[' + section + '][' + field + '][' + langId + ']'
        : page + '[' + section + '][' + field + ']';

      var html = '<table class="repeater-table table table-bordered table-condensed">';
      html += '<thead><tr>';
      columns.forEach(function(col) { html += '<th>' + col + '</th>'; });
      html += '<th style="width:36px"></th></tr></thead><tbody>';

      if (rows.length === 0) {
        html += '<tr><td colspan="' + (columns.length + 1) + '" style="text-align:center;color:#999;padding:12px;">No items</td></tr>';
      }

      rows.forEach(function(row, idx) {
        html += '<tr>';
        columns.forEach(function(col) {
          var val = row[col] || '';
          var cType = colTypes[col] || 'text';

          if (cType === 'textarea') {
            html += '<td><textarea name="repeater_temp">' + escapeHtml(val) + '</textarea></td>';
          } else if (cType === 'image') {
            // Image with OC3 file manager
            var iid = 'rep-img-' + container.id + '-' + idx + '-' + col;
            var imgSrc = val ? imageBase + val : ph;
            html += '<td>';
            html += '<a href="" id="thumb-' + iid + '" data-toggle="image" class="img-thumbnail"><img src="' + imgSrc + '" data-placeholder="' + ph + '" /></a>';
            html += '<input type="hidden" name="repeater_temp_img" value="' + escapeHtml(val) + '" id="input-' + iid + '" data-col="' + col + '" />';
            html += '</td>';
          } else {
            html += '<td><input type="text" name="repeater_temp" value="' + escapeHtml(val) + '" /></td>';
          }
        });
        html += '<td><button type="button" class="btn btn-danger btn-sm repeater-remove" data-idx="' + idx + '"><i class="fa fa-minus-circle"></i></button></td>';
        html += '</tr>';
      });

      html += '</tbody></table>';
      html += '<button type="button" class="btn btn-success btn-sm repeater-add-btn"><i class="fa fa-plus"></i> Add</button>';
      html += '<input type="hidden" name="' + namePrefix + '" class="repeater-json-value" value="" />';

      container.innerHTML = html;
      syncHidden();
    }

    function syncHidden() {
      var h = container.querySelector('.repeater-json-value');
      if (h) h.value = JSON.stringify(rows);
    }

    function collectFromDom() {
      var newRows = [];
      container.querySelectorAll('tbody tr').forEach(function(tr) {
        var obj = {};
        var textInputs = tr.querySelectorAll('input[name="repeater_temp"], textarea[name="repeater_temp"]');
        var imgInputs = tr.querySelectorAll('input[name="repeater_temp_img"]');
        var colIdx = 0;

        columns.forEach(function(col) {
          var cType = colTypes[col] || 'text';
          if (cType === 'image') {
            // Find img input for this column
            var imgInput = tr.querySelector('input[data-col="' + col + '"]');
            obj[col] = imgInput ? imgInput.value : '';
          } else {
            if (textInputs[colIdx]) {
              obj[col] = textInputs[colIdx].value;
              colIdx++;
            } else {
              obj[col] = '';
            }
          }
        });

        if (Object.keys(obj).length > 0) newRows.push(obj);
      });
      rows = newRows;
      syncHidden();
    }

    container.addEventListener('click', function(e) {
      if (e.target.closest('.repeater-add-btn')) {
        collectFromDom();
        var r = {}; columns.forEach(function(c) { r[c] = ''; }); rows.push(r);
        render();
      }
      if (e.target.closest('.repeater-remove')) {
        collectFromDom();
        rows.splice(parseInt(e.target.closest('.repeater-remove').dataset.idx), 1);
        render();
      }
    });

    // Listen for OC image manager changes on hidden inputs inside repeater
    var observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(m) {
        if (m.type === 'attributes' && m.attributeName === 'value') {
          collectFromDom();
        }
      });
    });
    // Observe will be set after render
    function observeImageInputs() {
      container.querySelectorAll('input[name="repeater_temp_img"]').forEach(function(inp) {
        observer.observe(inp, { attributes: true });
      });
    }

    container.addEventListener('input', function(e) {
      if (e.target.name === 'repeater_temp') collectFromDom();
    });

    var origRender = render;
    render = function() { origRender(); observeImageInputs(); };

    render();
  });

  // Watch all OC image hidden inputs for changes (file manager sets value)
  setInterval(function() {
    document.querySelectorAll('.repeater-container input[name="repeater_temp_img"]').forEach(function(inp) {
      var oldVal = inp.getAttribute('data-old') || '';
      if (inp.value !== oldVal) {
        inp.setAttribute('data-old', inp.value);
        // Update thumb
        var iid = inp.id.replace('input-', 'thumb-');
        var thumb = document.getElementById(iid);
        if (thumb) {
          var img = thumb.querySelector('img');
          if (img) img.src = inp.value ? imageBase + inp.value : placeholder;
        }
        // Trigger collect
        var cont = inp.closest('.repeater-container');
        if (cont) cont.dispatchEvent(new Event('input', {bubbles: true}));
      }
    });
  }, 300);

  function escapeHtml(t) {
    var d = document.createElement('div');
    d.appendChild(document.createTextNode(t || ''));
    return d.innerHTML;
  }

  // ===== Collect ALL repeaters before submit =====
  document.getElementById('form-static-content').addEventListener('submit', function() {
    document.querySelectorAll('.repeater-container').forEach(function(container) {
      // Re-collect from DOM to hidden input
      var columns, colTypes;
      try { columns = JSON.parse(container.dataset.columns || '[]'); } catch(e) { columns = []; }
      try { colTypes = JSON.parse(container.dataset.colTypes || '{}'); } catch(e) { colTypes = {}; }
      if (!columns.length) return;

      var newRows = [];
      container.querySelectorAll('tbody tr').forEach(function(tr) {
        var obj = {};
        var textInputs = tr.querySelectorAll('input[name="repeater_temp"], textarea[name="repeater_temp"]');
        var colIdx = 0;
        columns.forEach(function(col) {
          var cType = colTypes[col] || 'text';
          if (cType === 'image') {
            var imgInput = tr.querySelector('input[data-col="' + col + '"]');
            obj[col] = imgInput ? imgInput.value : '';
          } else {
            if (textInputs[colIdx]) {
              obj[col] = textInputs[colIdx].value;
              colIdx++;
            } else {
              obj[col] = '';
            }
          }
        });
        if (Object.keys(obj).length > 0) newRows.push(obj);
      });

      var h = container.querySelector('.repeater-json-value');
      if (h) h.value = JSON.stringify(newRows);
    });
  });

  // ===== WYSIWYG =====
  if (typeof $.fn.summernote !== 'undefined') {
    $('.wysiwyg-editor').summernote({
      height: 150,
      toolbar: [['style',['bold','italic','underline']],['para',['ul','ol','paragraph']],['insert',['link','picture']],['view',['codeview']]]
    });
  }
});
</script>

{{ footer }}
